{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Book Car | {{ car.name }}</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'bookings/book_car.css' %}">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Geocoder (Search Box) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
     
        #map {
            height: 400px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }


    </style>
</head>

<body style="background:#0b0f18; color:#fff; font-family:Segoe UI;">
<div class="container py-5">
    <h2 class="mb-2 fw-bold">Book Now</h2>
    <p class="text-secondary mb-4">Reserve your premium driving experience</p>

    <form method="POST">
        {% csrf_token %}
        <div class="row g-4">

            <!-- LEFT SIDE: Inputs -->
            <div class="col-lg-8">

                <!-- Map -->
                <div class="card bg-dark border-0 p-3 mb-3">
                    <label class="text-warning mb-2">Select Location on Map</label>
                    <div id="map"></div>
                        <!-- <button class="btn btn-danger mt-3" onclick="resetMap()">Reset Location</button> -->

                </div>    

                <!-- Pickup Location -->
                <div class="card bg-dark border-0 p-3 mb-3">
                    <label class="text-warning mb-1">Pickup Location</label>
                    {{ form.start_location }}
                </div>

                <!-- Drop Location -->
                <div class="card bg-dark border-0 p-3 mb-3">
                    <label class="text-warning mb-1">Drop Location</label>
                    {{ form.end_location }}
                </div>

                <!-- Dates -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="card bg-dark border-0 p-3">
                            <label class="text-warning">Pick-up Date</label>
                            {{ form.start_date }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-dark border-0 p-3">
                            <label class="text-warning">Return Date</label>
                            {{ form.end_date }}
                        </div>
                    </div>
                </div>

                <!-- Times -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="card bg-dark border-0 p-3">
                            <label class="text-warning">Pick-up Time</label>
                            {{ form.start_time }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-dark border-0 p-3">
                            <label class="text-warning">Return Time</label>
                            {{ form.end_time }}
                        </div>
                    </div>
                </div>

                {{ form.total_km }}

                {% if form.non_field_errors %}
                <div class="alert alert-danger mt-3">
                    {{ form.non_field_errors }}
                </div>
                {% endif %}

                <button type="submit" name="check_price" class="btn btn-warning w-100 mt-3 fw-bold">
                    Check Price
                </button>

                {% if total_price %}
                <div class="alert alert-success mt-3 text-center fw-bold">
                    Estimated Price: ₹{{ total_price }}
                </div>
                {% endif %}

            </div> <!-- END LEFT SIDE -->

            <!-- RIGHT SIDE: Invoice -->
            <div class="col-lg-4">
                <div class="card p-4 shadow bg-dark text-white">

                    <h4 class="mb-3">Price Summary</h4>

                    <div class="d-flex justify-content-between">
                        <span>Car</span>
                        <span>{{ car.name }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Total Hours</span>
                        <span>{{ total_hours|default:"0" }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Days</span>
                        <span>{{ total_days|default:"0" }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Allowed Distance</span>
                        <span>{{ allowed_km|default:"0" }} km</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Daily Rent</span>
                        <span>₹ {{ car.price_per_day }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Selected Distance</span>
                        <span>{{ selected_km }} km</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Service Fee</span>
                        <span>₹ {{ service_charge|default:"0" }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Insurance Fee</span>
                        <span>₹ {{ insurance_charge|default:"0" }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>Total</span>
                        <span>₹ {{ total_price|default:"0" }}</span>
                    </div>
<hr>
                    <!-- Terms & Conditions -->
<div class="card bg-dark border-0 p-3 mt-3">
    <h6 class="text-warning">Terms & Conditions</h6>
    <ul class="large text-secondary mb-2 terms-list">
        <li>Minimum billing is 1 day.</li>
        <li>Maximum allowed distance is {{ allowed_km|default:"0" }} km.</li>
        <li>Extra distance will be charged per km.</li>
        <li>Booking cancellation allowed within 24 hours only.</li>
        <li>Driver must carry valid driving license.</li>
    </ul>

    <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="agreeTerms" onchange="toggleConfirm()">
        <label class="form-check-label text-light" for="agreeTerms">
            I agree with Terms & Conditions
        </label>
    </div>
    

                       <button id="confirmBtn" disabled type="submit" name="confirm_booking"
    class="btn btn-warning w-100 mt-3 fw-bold">
    Confirm Booking & Proceed to Payment
</button>
                    </div>

                </div>
            </div> <!-- END RIGHT SIDE -->

        </div> <!-- END ROW -->
    </form>
</div> <!-- END CONTAINER -->


    </div>

    <script>
        let map, startMarker, endMarker, routeLayer;

        // Init map
        map = L.map('map').setView([20.5937, 78.9629], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // Search control
        L.Control.geocoder({
            defaultMarkGeocode: false
        })
            .on('markgeocode', function (e) {

                const latlng = e.geocode.center;
                map.setView(latlng, 13);

                if (!startMarker) {
                    startMarker = L.marker(latlng).addTo(map);
                    reverseGeocode(latlng, 'id_start_location');

                } else if (!endMarker) {
                    endMarker = L.marker(latlng).addTo(map);
                    reverseGeocode(latlng, 'id_end_location');
                    calculateRoute();
                }

            })
            .addTo(map);

        // Map click logic
        map.on('click', function (e) {

            if (!startMarker) {
                startMarker = L.marker(e.latlng).addTo(map);
                reverseGeocode(e.latlng, 'id_start_location');

            } else if (!endMarker) {
                endMarker = L.marker(e.latlng).addTo(map);
                reverseGeocode(e.latlng, 'id_end_location');
                calculateRoute();
            }
        });

        // Reverse geocode
        function reverseGeocode(latlng, inputId) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById(inputId).value =
                        data.display_name || "Selected location";
                });
        }

        // Route calculation
        function calculateRoute() {
            const s = startMarker.getLatLng();
            const e = endMarker.getLatLng();

            fetch(`https://router.project-osrm.org/route/v1/driving/${s.lng},${s.lat};${e.lng},${e.lat}?overview=full&geometries=geojson`)
                .then(res => res.json())
                .then(data => {
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.geoJSON(data.routes[0].geometry).addTo(map);

                    const km = data.routes[0].distance / 1000;
                    document.getElementById("id_total_km").value = km.toFixed(2);
                });
        }

        // Reset map
        function resetMap() {
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeLayer) map.removeLayer(routeLayer);

            startMarker = null;
            endMarker = null;

            document.getElementById("id_start_location").value = "";
            document.getElementById("id_end_location").value = "";
            document.getElementById("id_total_km").value = "";
        }
       
function calculatePrice() {

    let startDate = document.getElementById("id_start_date").value;
    let endDate = document.getElementById("id_end_date").value;

    if (!startDate || !endDate) {
        alert("Please select dates");
        return;
    }

    let start = new Date(startDate);
    let end = new Date(endDate);

    let diffTime = end - start;
    let days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (days <= 0) days = 1;

    let dailyPrice = parseFloat(document.getElementById("dailyPrice").innerText);

    let total = dailyPrice * days;
    let allowedKm = days * 800;

    document.getElementById("days").innerText = days;
    document.getElementById("total").innerText = total;
    document.getElementById("allowedKm").innerText = allowedKm + " km";
}
function toggleConfirm() {
    const checkbox = document.getElementById('agreeTerms');
    const button = document.getElementById('confirmBtn');
    button.disabled = !checkbox.checked;
}


    </script>

</body>

</html>